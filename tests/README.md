# Тестирование WinDI Messenger

В этой директории находятся тесты для проекта WinDI Messenger. Тесты разделены на несколько категорий для эффективного тестирования различных аспектов приложения.

## Структура тестов

```
tests/
├── unit/                  # Модульные тесты
│   ├── core/              # Тесты компонентов ядра приложения
│   ├── utils/             # Тесты утилит
│   └── models/            # Тесты моделей данных
├── integration/           # Интеграционные тесты
│   ├── api/               # Тесты API endpoints
│   └── centrifugo/        # Тесты интеграции с Centrifugo
├── e2e/                   # Сквозные тесты
│   └── scenarios/         # Пользовательские сценарии
├── performance/           # Тесты производительности
│   └── load/              # Нагрузочные тесты
├── conftest.py            # Общие фикстуры для всех тестов
└── pytest.ini             # Конфигурация pytest
```

## Запуск тестов

### Все тесты

```bash
pytest
```

### Модульные тесты

```bash
pytest tests/unit/
```

### Интеграционные тесты

```bash
pytest tests/integration/
```

### Тесты производительности

```bash
pytest tests/performance/
```

### Сквозные тесты

```bash
pytest tests/e2e/
```

### Запуск с маркерами

```bash
# Модульные тесты
pytest -m unit

# Интеграционные тесты
pytest -m integration

# Тесты производительности
pytest -m performance

# Медленные тесты
pytest -m slow
```

## Фикстуры

В проекте используются различные фикстуры для подготовки тестового окружения:

### Общие фикстуры (`conftest.py`)

- `auth_token` - получение токена авторизации
- `centrifugo_token` - получение токена для Centrifugo
- `test_chat_id` - создание или получение тестового чата

### Фикстуры для модульных тестов (`unit/conftest.py`)

- `mock_centrifugo_client_unit` - мок для клиента Centrifugo
- `test_centrifugo_manager` - экземпляр CentrifugoManager для тестов
- `test_centrifugo_client` - экземпляр CentrifugoClient для тестов
- `mock_httpx_client` - мок для HTTP-клиента

### Фикстуры для интеграционных тестов (`integration/conftest.py`)

- `test_message_data` - данные для тестового сообщения
- `create_test_message` - создание тестового сообщения
- `get_message_history` - получение истории сообщений
- `check_centrifugo_presence` - проверка присутствия пользователей

### Фикстуры для e2e тестов (`e2e/conftest.py`)

- `user_session` - сессия основного пользователя
- `second_user_session` - сессия второго пользователя

### Фикстуры для тестов производительности (`performance/conftest.py`)

- `load_test_results` - объект для сбора результатов тестов
- `authenticated_session` - аутентифицированная сессия
- `test_chat_for_load` - тестовый чат для нагрузочных тестов

## Рекомендации по написанию тестов

### Модульные тесты

- Тестируйте небольшие блоки кода в изоляции
- Используйте моки для внешних зависимостей
- Проверяйте пограничные случаи и обработку ошибок
- Именуйте тесты в формате `test_<тестируемая_функция>_<сценарий>`

### Интеграционные тесты

- Тестируйте взаимодействие между компонентами
- Не используйте моки для тестируемых взаимодействий
- Создавайте необходимые тестовые данные в начале теста
- Очищайте тестовые данные после завершения теста

### Тесты производительности

- Используйте параметризацию для разных уровней нагрузки
- Сохраняйте метрики производительности для анализа
- Проверяйте, что система обрабатывает требуемое количество запросов
- Устанавливайте пороговые значения для проверок производительности

### Сквозные тесты

- Тестируйте полные пользовательские сценарии
- Используйте класс `UserSession` для имитации пользователей
- Проверяйте, что система работает корректно в целом
- Фокусируйтесь на проверке бизнес-логики приложения

## Дополнительные ресурсы

- [Документация pytest](https://docs.pytest.org/)
- [pytest-asyncio](https://github.com/pytest-dev/pytest-asyncio)
- [Написание хороших тестов](https://docs.pytest.org/en/latest/goodpractices.html) 